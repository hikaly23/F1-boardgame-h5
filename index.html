<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>F1 Driver Life (H5 MVP)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a29;
      --card2:#0f1624;
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --good:#7CFFB2;
      --bad:#FF6B6B;
      --accent:#7AA2FF;
      --accent2:#B47CFF;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(1200px 800px at 90% 20%, rgba(180,124,255,.16), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Noto Sans CJK SC",sans-serif;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:center;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .hud{
      width: 360px;
      min-width: 320px;
      padding: 14px;
    }
    .boardCard{
      width: 520px;
      min-width: 320px;
      padding: 14px;
    }
    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .title h1{
      font-size:18px;
      margin:0;
      letter-spacing:.3px;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .stat{
      flex:1 1 48%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      min-width:150px;
    }
    .stat .k{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.6px;
    }
    .stat .v{
      margin-top:4px;
      font-size:18px;
      font-weight:700;
    }
    .bar{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top:8px;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar > div{
      height:100%;
      width:50%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    .btns{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      appearance:none;
      border:none;
      border-radius:14px;
      padding: 12px 14px;
      font-size:14px;
      font-weight:650;
      color:var(--text);
      background: linear-gradient(135deg, rgba(122,162,255,.9), rgba(180,124,255,.9));
      box-shadow: 0 8px 22px rgba(122,162,255,.15);
      cursor:pointer;
      flex: 1 1 auto;
      min-width: 140px;
    }
    button:active{ transform: translateY(1px); }
    .ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      font-weight:600;
      color: rgba(255,255,255,.85);
    }
    .log{
      margin-top:12px;
      background: rgba(0,0,0,.16);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      max-height: 260px;
      overflow:auto;
      font-size:12px;
      color: rgba(255,255,255,.78);
      line-height:1.5;
    }
    .log .t{ color: rgba(255,255,255,.92); font-weight:650;}
    .log .good{ color: var(--good); font-weight:650;}
    .log .bad{ color: var(--bad); font-weight:650;}
    .log .muted{ color: var(--muted); }
    .board{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .cell{
      aspect-ratio: 1/1;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
      padding:8px;
    }
    .cell .tag{
      font-size:11px;
      color: rgba(255,255,255,.76);
      padding: 4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }
    .cell .idx{
      position:absolute;
      top:8px;
      left:8px;
      font-size:11px;
      color: rgba(255,255,255,.45);
    }
    .cell.training{ background: rgba(122,162,255,.10); }
    .cell.pr{ background: rgba(180,124,255,.10); }
    .cell.sponsor{ background: rgba(124,255,178,.08); }
    .cell.rival{ background: rgba(255,175,85,.09); }
    .cell.team{ background: rgba(255,255,255,.06); }
    .cell.accident{ background: rgba(255,107,107,.10); }
    .cell.race{ background: rgba(255,255,255,.08); }
    .cell.start{ background: rgba(255,255,255,.10); }

    .token{
      position:absolute;
      right:8px;
      top:8px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.2));
      border:1px solid rgba(255,255,255,.35);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
    }

    /* modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(560px, 96vw);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.16);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 24px 80px rgba(0,0,0,.50);
    }
    .modalHeader{
      padding: 14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHeader .h{
      font-size:16px;
      font-weight:750;
      margin:0;
    }
    .modalHeader .p{
      margin:6px 0 0;
      font-size:13px;
      color: rgba(255,255,255,.72);
      line-height:1.5;
    }
    .modalBody{ padding: 12px 14px 14px; }
    .choices{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .choice{
      padding: 12px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      user-select:none;
    }
    .choice:active{ transform: translateY(1px); }
    .choice .ct{ font-weight:700; }
    .choice .ce{
      margin-top:6px;
      font-size:12px;
      color: rgba(255,255,255,.68);
    }
    .pill{
      display:inline-block;
      padding: 3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      font-size:11px;
      color: rgba(255,255,255,.72);
      margin-right:6px;
    }
    .tiny{
      font-size:11px;
      color: rgba(255,255,255,.62);
    }
    .foot{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 2px 6px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.78);
      font-size:11px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel hud">
      <div class="title">
        <div>
          <h1>F1 è½¦æ‰‹äººç”Ÿ Â· H5 MVP</h1>
          <div class="subtitle">æ·éª°å­èµ°æ ¼å­ â†’ è§¦å‘äº‹ä»¶ â†’ èµ›å­£æ¨è¿›ï¼ˆç®€åŒ–ç‰ˆï¼‰</div>
        </div>
        <div class="tiny"><span class="kbd">v0.1</span></div>
      </div>

      <div class="row" id="stats"></div>

      <div class="btns">
        <button id="rollBtn">ğŸ² æ·éª°å­</button>
        <button class="ghost" id="resetBtn">â†º é‡å¼€èµ›å­£</button>
      </div>

      <div class="log" id="log"></div>
    </div>

    <div class="panel boardCard">
      <div class="title">
        <div>
          <h1>èµ›å­£æ£‹ç›˜</h1>
          <div class="subtitle">æ¯èµ°ä¸€æ­¥è§¦å‘ï¼šè®­ç»ƒ / PR / èµåŠ© / è½¦é˜Ÿ / å¯¹æ‰‹ / æ„å¤– / æ¯”èµ›å‘¨</div>
        </div>
        <div class="tiny">å½“å‰ä½ç½®ï¼š<span class="kbd" id="posText">0</span></div>
      </div>

      <div class="board" id="board"></div>

      <div class="foot">
        <div class="tiny">
          å°æç¤ºï¼šå…ˆåšæˆâ€œå¯ç©éª¨æ¶â€ï¼Œå†é€æ­¥åŠ ï¼šè½¬ä¼šçª—ã€è½¦é˜Ÿä¿¡ä»»ã€ç ”å‘è¿›åº¦ã€é›¨æˆ˜ã€é˜Ÿå‹ç­‰ã€‚
        </div>
        <div class="tiny">ä¸‹ä¸€ç«™ï¼šç¬¬ <span id="weekText">1</span> å‘¨ / å…± <span id="seasonLenText">12</span> å‘¨</div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <p class="h" id="mTitle">äº‹ä»¶æ ‡é¢˜</p>
        <p class="p" id="mDesc">äº‹ä»¶æè¿°</p>
      </div>
      <div class="modalBody">
        <div id="mMeta" class="tiny"></div>
        <div class="choices" id="mChoices"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== Utils ======
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const rint = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
    const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
    const fmtDelta = (n)=> (n>0?`+${n}`:`${n}`);

    // ====== Game State ======
    const SEASON_LEN = 12;           // ä¸€å­£ 12 å‘¨ï¼ˆç¤ºä¾‹ï¼‰
    const BOARD_LEN  = 24;           // 24 æ ¼å¾ªç¯
    let state;

    const TILE_TYPES = [
      "start","training","pr","sponsor","rival","team","accident","race"
    ];

    // ç®€æ˜“æ£‹ç›˜ï¼šæ¯æ ¼ä¸€ä¸ªç±»å‹ï¼ˆä½ åé¢å¯ä»¥æ¢æˆJSONé…ç½®ï¼‰
    const boardTypes = Array.from({length: BOARD_LEN}, (_,i)=>{
      if(i===0) return "start";
      if(i%6===0) return "race";
      if(i%7===0) return "accident";
      if(i%5===0) return "team";
      if(i%4===0) return "rival";
      if(i%3===0) return "sponsor";
      if(i%2===0) return "pr";
      return "training";
    });

    const tileName = {
      start:"Paddock",
      training:"è®­ç»ƒ",
      pr:"åª’ä½“",
      sponsor:"èµåŠ©",
      rival:"å¯¹æ‰‹",
      team:"è½¦é˜Ÿ",
      accident:"æ„å¤–",
      race:"æ¯”èµ›å‘¨"
    };

    function freshState(){
      return {
        pos: 0,
        week: 1,
        finished: false,
        stats: {
          pace: 50,
          racecraft: 45,
          consistency: 50,
          fitness: 50,
          reputation: 35,
          money: 20,
          points: 0,
          trust: 40,       // è½¦é˜Ÿä¿¡ä»»ï¼ˆç¤ºä¾‹ï¼‰
        }
      };
    }

    // ====== Event Pools ======
    // æ¯ä¸ªäº‹ä»¶ï¼štitle, desc, choices: [{t, e, apply(state)}]
    const EVENTS = {
      training: [
        {
          title:"æ¨¡æ‹Ÿå™¨åŠ ç»ƒ",
          desc:"å·¥ç¨‹å¸ˆé—®ä½ è¦ä¸è¦æŠŠä»Šæ™šç•™ç»™æ¨¡æ‹Ÿå™¨ã€‚å¼ºåº¦æ‹‰æ»¡ï¼Œä½†ä¼šæ¶ˆè€—ç²¾åŠ›ä¸èµ„æºã€‚",
          choices:[
            { t:"åŠ ç»ƒåˆ°æ·±å¤œ", e:"PACE +3ï¼ŒFITNESS -2ï¼ŒMONEY -2", apply:s=>{
              s.stats.pace+=3; s.stats.fitness-=2; s.stats.money-=2;
            }},
            { t:"é€‚åº¦è®­ç»ƒ", e:"PACE +1ï¼ŒCONSISTENCY +1", apply:s=>{
              s.stats.pace+=1; s.stats.consistency+=1;
            }},
            { t:"ä¼‘æ¯æ¢å¤", e:"FITNESS +3ï¼ŒCONSISTENCY +1", apply:s=>{
              s.stats.fitness+=3; s.stats.consistency+=1;
            }},
          ]
        },
        {
          title:"è½®èƒç®¡ç†ç‰¹è®­",
          desc:"æ•™ç»ƒç»™ä½ å®‰æ’äº†è½®èƒç®¡ç†ä¸é•¿è·ç¦»èŠ‚å¥è®­ç»ƒã€‚",
          choices:[
            { t:"ä¸“æ³¨é•¿è·ç¦»", e:"RACECRAFT +3", apply:s=>{ s.stats.racecraft+=3; }},
            { t:"å¼ºåŒ–ç¨³å®šæ€§", e:"CONSISTENCY +3", apply:s=>{ s.stats.consistency+=3; }},
            { t:"ä¸¤è€…éƒ½è¦", e:"RACECRAFT +1ï¼ŒCONSISTENCY +1ï¼ŒFITNESS -1", apply:s=>{
              s.stats.racecraft+=1; s.stats.consistency+=1; s.stats.fitness-=1;
            }},
          ]
        },
      ],
      pr: [
        {
          title:"åª’ä½“æé—®ï¼šä½ å¯¹é˜Ÿå‹æ€ä¹ˆçœ‹ï¼Ÿ",
          desc:"è®°è€…æ•…æ„å¼•å¯¼å¯¹ç«‹ã€‚ä½ ä¸€å¥è¯èƒ½å†³å®šé£å‘ã€‚",
          choices:[
            { t:"å¤¸é˜Ÿå‹ã€å¤¸å›¢é˜Ÿ", e:"REPUTATION +2ï¼ŒTRUST +2", apply:s=>{
              s.stats.reputation+=2; s.stats.trust+=2;
            }},
            { t:"å¼ºè°ƒæˆ‘æ›´å¿«", e:"REPUTATION +3ï¼ŒTRUST -2", apply:s=>{
              s.stats.reputation+=3; s.stats.trust-=2;
            }},
            { t:"å†·å¤„ç†ä¸æ¥æ‹›", e:"CONSISTENCY +1ï¼ŒREPUTATION +0", apply:s=>{
              s.stats.consistency+=1;
            }},
          ]
        },
        {
          title:"PRæ´»åŠ¨æ’é˜Ÿ",
          desc:"èµåŠ©æ–¹è¦ä½ ä¸´æ—¶å‡ºå¸­æ´»åŠ¨ï¼Œä¼šæŒ¤å è®­ç»ƒæ—¶é—´ã€‚",
          choices:[
            { t:"å»ï¼Œç»™è¶³é¢å­", e:"REPUTATION +3ï¼ŒMONEY +2ï¼ŒPACE -1", apply:s=>{
              s.stats.reputation+=3; s.stats.money+=2; s.stats.pace-=1;
            }},
            { t:"åªè§†é¢‘è¿çº¿", e:"REPUTATION +1", apply:s=>{ s.stats.reputation+=1; }},
            { t:"æ‹’ç»", e:"PACE +1ï¼ŒREPUTATION -2", apply:s=>{
              s.stats.pace+=1; s.stats.reputation-=2;
            }},
          ]
        },
      ],
      sponsor: [
        {
          title:"èµåŠ©åˆçº¦ï¼šå‡ºå¸­æ¡æ¬¾",
          desc:"èµåŠ©å•†æ„¿æ„åŠ é’±ï¼Œä½†è¦æ±‚ä½ æ¯ä¸¤å‘¨å¿…é¡»å‚åŠ ä¸€æ¬¡å•†ä¸šæ´»åŠ¨ã€‚",
          choices:[
            { t:"ç­¾ï¼šé’±æ›´é‡è¦", e:"MONEY +6ï¼ŒREPUTATION +1ï¼Œ(è½»å¾®è®­ç»ƒæƒ©ç½šä»¥åå†åš)", apply:s=>{
              s.stats.money+=6; s.stats.reputation+=1;
            }},
            { t:"è°ˆæ¡ä»¶", e:"MONEY +3ï¼ŒTRUST +1", apply:s=>{
              s.stats.money+=3; s.stats.trust+=1;
            }},
            { t:"ä¸ç­¾", e:"REPUTATION +0ï¼ŒMONEY +0", apply:s=>{}},
          ]
        },
      ],
      rival: [
        {
          title:"å¯¹æ‰‹é€¼ä½ å‡ºç•Œ",
          desc:"ç»ƒä¹ èµ›å¯¹æ‰‹å¼ºç¡¬æŒ¤å‹ï¼Œä½ å¯ä»¥ç¡¬åˆšï¼Œä¹Ÿå¯ä»¥è®©å¼€ä¿èƒã€‚",
          choices:[
            { t:"ç¡¬åˆšåˆ°åº•", e:"REPUTATION +2ï¼ŒCONSISTENCY -2", apply:s=>{
              s.stats.reputation+=2; s.stats.consistency-=2;
            }},
            { t:"è®©å¼€ä¿èƒ", e:"RACECRAFT +2ï¼ŒREPUTATION -1", apply:s=>{
              s.stats.racecraft+=2; s.stats.reputation-=1;
            }},
            { t:"æ— çº¿ç”µè¦æ±‚è£åˆ¤", e:"REPUTATION +1ï¼ŒTRUST -1", apply:s=>{
              s.stats.reputation+=1; s.stats.trust-=1;
            }},
          ]
        },
      ],
      team: [
        {
          title:"å‡çº§ä¼˜å…ˆçº§ä¼šè®®",
          desc:"è½¦é˜Ÿåªå¤Ÿåšä¸€é¡¹å‡çº§ï¼Œä½ æƒ³è¦æ›´å¿«çš„è½¦è¿˜æ˜¯æ›´ç¨³çš„è½¦ï¼Ÿ",
          choices:[
            { t:"è¿½æ±‚é€Ÿåº¦", e:"PACE +2ï¼ŒTRUST +1", apply:s=>{
              s.stats.pace+=2; s.stats.trust+=1;
            }},
            { t:"è¿½æ±‚ç¨³å®š", e:"CONSISTENCY +2ï¼ŒTRUST +1", apply:s=>{
              s.stats.consistency+=2; s.stats.trust+=1;
            }},
            { t:"è¦ä¸¤å¥—å‡çº§", e:"TRUST -2ï¼ˆè¢«è®¤ä¸ºä¸ç°å®ï¼‰", apply:s=>{
              s.stats.trust-=2;
            }},
          ]
        },
      ],
      accident: [
        {
          title:"åˆ¹è½¦é—®é¢˜",
          desc:"å·¥ç¨‹å¸ˆå‘ç°åˆ¹è½¦æ¸©åº¦å¼‚å¸¸ã€‚ä½ å¯ä»¥å†’é™©ç»§ç»­ï¼Œä¹Ÿå¯ä»¥æ¢éƒ¨ä»¶ç½šä½ã€‚",
          choices:[
            { t:"ç»§ç»­è·‘", e:"PACE +1ï¼ˆç†Ÿæ‚‰æé™ï¼‰ï¼ŒCONSISTENCY -3", apply:s=>{
              s.stats.pace+=1; s.stats.consistency-=3;
            }},
            { t:"æ¢éƒ¨ä»¶ä¿å®Œèµ›", e:"CONSISTENCY +1ï¼ŒREPUTATION +1ï¼ŒMONEY -2", apply:s=>{
              s.stats.consistency+=1; s.stats.reputation+=1; s.stats.money-=2;
            }},
            { t:"ä¸ŠæŠ¥å¹¶è®©è½¦é˜Ÿå†³ç­–", e:"TRUST +2", apply:s=>{
              s.stats.trust+=2;
            }},
          ]
        },
      ],
      race: [
        {
          title:"æ¯”èµ›å‘¨ï¼šæ’ä½ä¸æ­£èµ›ç»“ç®—",
          desc:"ç®€åŒ–ç»“ç®—ï¼šæ ¹æ®å±æ€§è®¡ç®—æ’ä½ä¸æ­£èµ›è¡¨ç°ï¼Œç»™ç§¯åˆ†ä¸å£°æœ›ã€‚",
          choices:[
            { t:"å¼€å§‹æ¯”èµ›ç»“ç®—", e:"è¿›è¡Œä¸€æ¬¡ç»“ç®—", apply:s=>{
              runRace(s);
            }},
          ]
        },
      ],
      start: [
        {
          title:"æ–°èµ›å­£å¼€å§‹",
          desc:"æ¬¢è¿æ¥åˆ°å›´åœºã€‚ä½ çš„ç›®æ ‡ï¼šåœ¨ 12 å‘¨å†…å°½é‡æ‹¿åˆ°æ›´å¤šç§¯åˆ†ï¼Œå¹¶æé«˜å£°æœ›ä¸è½¦é˜Ÿä¿¡ä»»ã€‚",
          choices:[
            { t:"å‡ºå‘", e:"å¼€å§‹èµ›å­£", apply:s=>{} }
          ]
        }
      ]
    };

    // ====== Race Resolution (ç®€åŒ–) ======
    function runRace(s){
      // åŸºç¡€è¡¨ç°åˆ†ï¼šé€Ÿåº¦+æ­£èµ›+ç¨³å®š+ä½“èƒ½/ä¿¡ä»»ä¸€äº›å¾®è°ƒ
      const st = s.stats;
      const perfQual = st.pace*0.55 + st.consistency*0.25 + st.fitness*0.20 + rint(-6,6);
      const perfRace = st.pace*0.35 + st.racecraft*0.35 + st.consistency*0.20 + st.fitness*0.10 + rint(-8,8) + (st.trust-40)*0.08;

      // æ’ä½åæ¬¡ä¼°ç®—ï¼ˆè¶Šé«˜è¶Šå¥½ï¼‰
      const q = scoreToPos(perfQual);
      const r = scoreToPos(perfRace);

      let pts = pointsForPos(r);
      st.points += pts;

      // å£°æœ›ï¼šæ’ä½å¥½/æ­£èµ›å¥½éƒ½æœ‰åŠ æˆï¼ŒDNFæ¦‚ç‡å—ç¨³å®šå½±å“
      const dnfRoll = Math.random();
      const dnfChance = clamp(0.18 - (st.consistency-50)*0.003, 0.05, 0.22);
      let dnf = dnfRoll < dnfChance;

      if(dnf){
        // DNFï¼šç§¯åˆ†æ¸…é›¶ï¼Œå£°æœ›ç•¥é™ï¼Œç¨³å®šå¯èƒ½ä¸‹é™
        pts = 0;
        st.reputation -= 2;
        st.consistency -= 2;
        logLine(`ğŸ æ¯”èµ›ç»“æœï¼šæ’ä½ P${q}ï¼Œæ­£èµ› DNFã€‚ <span class="bad">å£°æœ› -2</span>`, true);
      }else{
        st.reputation += (r<=10?2:1) + (q<=5?1:0);
        st.money += (r<=10?2:0);
        st.trust += (r<=8?1:0);
        logLine(`ğŸ æ¯”èµ›ç»“æœï¼šæ’ä½ P${q}ï¼Œæ­£èµ› P${r}ï¼Œç§¯åˆ† <span class="good">+${pts}</span>`, true);
      }

      // èµ›å­£æ¨è¿›
      s.week += 1;
      if(s.week > SEASON_LEN){
        s.finished = true;
        endSeason();
      } else {
        updateHUD();
      }
    }

    function scoreToPos(score){
      // ç²—æš´æ˜ å°„ï¼šåˆ†æ•°åŒºé—´å¯¹åº”åæ¬¡
      // ç›®æ ‡ï¼š50å·¦å³åœ¨P12~P15ï¼Œ70+èƒ½è¿›å‰10
      const s = clamp(score, 0, 100);
      if(s>=85) return rint(1,3);
      if(s>=78) return rint(3,6);
      if(s>=70) return rint(6,10);
      if(s>=62) return rint(10,14);
      if(s>=55) return rint(14,17);
      if(s>=48) return rint(17,20);
      return rint(20,20);
    }
    function pointsForPos(pos){
      const table = {1:25,2:18,3:15,4:12,5:10,6:8,7:6,8:4,9:2,10:1};
      return table[pos] || 0;
    }

    // ====== UI Render ======
    const elBoard = document.getElementById("board");
    const elStats = document.getElementById("stats");
    const elLog = document.getElementById("log");
    const elPosText = document.getElementById("posText");
    const elWeekText = document.getElementById("weekText");
    const elSeasonLenText = document.getElementById("seasonLenText");

    const modalBack = document.getElementById("modalBack");
    const mTitle = document.getElementById("mTitle");
    const mDesc  = document.getElementById("mDesc");
    const mChoices = document.getElementById("mChoices");
    const mMeta = document.getElementById("mMeta");

    const rollBtn = document.getElementById("rollBtn");
    const resetBtn = document.getElementById("resetBtn");

    function renderBoard(){
      elBoard.innerHTML = "";
      for(let i=0;i<BOARD_LEN;i++){
        const type = boardTypes[i];
        const cell = document.createElement("div");
        cell.className = `cell ${type}`;
        cell.innerHTML = `
          <div class="idx">#${i}</div>
          <div class="tag">${tileName[type]}</div>
          ${i===state.pos?`<div class="token" title="ä½ "></div>`:""}
        `;
        elBoard.appendChild(cell);
      }
    }

    function renderStats(){
      const st = state.stats;
      const items = [
        ["PACE", st.pace, 0, 100],
        ["RACE", st.racecraft, 0, 100],
        ["STABLE", st.consistency, 0, 100],
        ["FIT", st.fitness, 0, 100],
        ["REP", st.reputation, 0, 100],
        ["TRUST", st.trust, 0, 100],
        ["MONEY", st.money, -20, 80],
        ["PTS", st.points, 0, 200],
      ];
      elStats.innerHTML = items.map(([k,v,lo,hi])=>{
        const pct = clamp((v-lo)/(hi-lo)*100, 0, 100);
        return `
          <div class="stat">
            <div class="k">${k}</div>
            <div class="v">${Math.round(v)}</div>
            <div class="bar"><div style="width:${pct}%"></div></div>
          </div>
        `;
      }).join("");
    }

    function logLine(text, keep=false){
      const d = document.createElement("div");
      d.innerHTML = text;
      if(!keep){
        // æ§åˆ¶æ—¥å¿—é‡
        if(elLog.childNodes.length > 60){
          elLog.removeChild(elLog.firstChild);
        }
      }
      elLog.appendChild(d);
      elLog.scrollTop = elLog.scrollHeight;
    }

    function updateHUD(){
      // clamp stats
      const st = state.stats;
      for(const k of ["pace","racecraft","consistency","fitness","reputation","trust"]){
        st[k] = clamp(st[k], 0, 100);
      }
      st.money = clamp(st.money, -20, 200);
      st.points = clamp(st.points, 0, 999);

      elPosText.textContent = state.pos;
      elWeekText.textContent = state.week;
      elSeasonLenText.textContent = SEASON_LEN;

      renderStats();
      renderBoard();

      rollBtn.disabled = state.finished;
      rollBtn.textContent = state.finished ? "ğŸ èµ›å­£å·²ç»“æŸ" : "ğŸ² æ·éª°å­";
    }

    // ====== Modal ======
    let pendingEvent = null;

    function openEvent(type){
      const pool = EVENTS[type] || EVENTS.training;
      const ev = pick(pool);
      pendingEvent = {type, ev};

      mTitle.textContent = ev.title;
      mDesc.textContent = ev.desc;
      mMeta.innerHTML = `
        <span class="pill">æ ¼å­ï¼š${tileName[type]}</span>
        <span class="pill">ç¬¬ ${state.week} å‘¨</span>
        <span class="pill">ä½ç½® #${state.pos}</span>
        <div class="tiny" style="margin-top:8px;color:rgba(255,255,255,.60);">
          é€‰æ‹©ä¼šç«‹å³ç”Ÿæ•ˆã€‚æ¯”èµ›å‘¨ä¼šæ¨è¿›å‘¨æ•°ï¼ˆèµ›å­£è¿›åº¦ï¼‰ã€‚
        </div>
      `;

      mChoices.innerHTML = "";
      ev.choices.forEach((c, idx)=>{
        const div = document.createElement("div");
        div.className = "choice";
        div.innerHTML = `
          <div class="ct">${idx+1}. ${c.t}</div>
          <div class="ce">${c.e}</div>
        `;
        div.addEventListener("click", ()=>{
          applyChoice(c);
        });
        mChoices.appendChild(div);
      });

      modalBack.style.display = "flex";
    }

    function closeEvent(){
      modalBack.style.display = "none";
      pendingEvent = null;
    }

    function applyChoice(choice){
      // æ‰§è¡Œ
      choice.apply(state);

      // æ—¥å¿—ï¼šç®€å•è§£æä¸€ä¸‹ e æ–‡æ¡ˆ
      const tag = tileName[pendingEvent.type];
      logLine(`<span class="t">[${tag}]</span> ${pendingEvent.ev.title} â†’ ä½ é€‰æ‹©äº†ã€Œ${choice.t}ã€<div class="muted">${choice.e}</div>`);
      closeEvent();
      updateHUD();

      // éæ¯”èµ›æ ¼ä¹Ÿæ¨è¿›â€œå‘¨â€å—ï¼Ÿè¿™é‡Œå…ˆä¸æ¨è¿›ï¼Œåªåœ¨æ¯”èµ›å‘¨æ¨è¿›
      // ä½ åé¢æƒ³åšâ€œæ¯æ¬¡è¡ŒåŠ¨+1å‘¨â€ï¼Œå°±æŠŠè¿™é‡Œ state.week++ æ”¾å¼€ã€‚
    }

    // ====== Actions ======
    function rollDice(){
      if(state.finished) return;

      const dice = rint(1,6);
      const from = state.pos;
      state.pos = (state.pos + dice) % BOARD_LEN;

      logLine(`ğŸ² æ·éª°å­ï¼š<span class="good">+${dice}</span>ï¼ˆä» #${from} â†’ #${state.pos}ï¼‰`);
      updateHUD();

      const type = boardTypes[state.pos];
      openEvent(type);
    }

    function endSeason(){
      updateHUD();
      const st = state.stats;
      const tier =
        st.points >= 80 ? "äº‰å† çº§ï¼ˆé¡¶çº§å¸­ä½ç¨³äº†ï¼‰" :
        st.points >= 40 ? "å¼ºåŠ¿ä¸­ä¸Šæ¸¸ï¼ˆè½¬ä¼šçª—æœ‰æˆï¼‰" :
        st.points >= 15 ? "ä¸­æ¸¸èµ·ä¼ï¼ˆéœ€è¦æ›´ç¨³å®šï¼‰" :
        "å±é™©è¾¹ç¼˜ï¼ˆå¯èƒ½è¢«æ¢ï¼‰";

      // ç”¨å¼¹çª—å±•ç¤ºèµ›å­£æ€»ç»“
      pendingEvent = {type:"race", ev:{title:"èµ›å­£ç»“æŸï¼šæ€»ç»“", desc:"", choices:[]}};
      mTitle.textContent = "ğŸ† èµ›å­£ç»“æŸï¼šæ€»ç»“";
      mDesc.textContent = `12 å‘¨ç»“æŸã€‚ä½ çš„èµ›å­£èµ°å‘å·²å®šã€‚`;
      mMeta.innerHTML = `
        <div style="line-height:1.7">
          <span class="pill">æ€»ç§¯åˆ†ï¼š${st.points}</span>
          <span class="pill">å£°æœ›ï¼š${Math.round(st.reputation)}</span>
          <span class="pill">è½¦é˜Ÿä¿¡ä»»ï¼š${Math.round(st.trust)}</span>
          <div style="margin-top:10px" class="tiny">
            è¯„çº§ï¼š<span class="kbd">${tier}</span>
          </div>
          <div class="tiny" style="margin-top:10px;color:rgba(255,255,255,.70)">
            ä¸‹ä¸€æ­¥ä½ å¯ä»¥åŠ ï¼šè½¬ä¼šæŠ¥ä»·ã€åˆåŒè°ˆåˆ¤ã€é˜Ÿå‹å…³ç³»ã€ç ”å‘æ ‘ã€é›¨æˆ˜äº‹ä»¶æ± ç­‰ã€‚
          </div>
        </div>
      `;
      mChoices.innerHTML = "";
      const div = document.createElement("div");
      div.className = "choice";
      div.innerHTML = `<div class="ct">é‡å¼€èµ›å­£</div><div class="ce">ä¿ç•™å½“å‰ç‰ˆæœ¬ï¼Œé‡æ–°å¼€å§‹ä¸€å±€</div>`;
      div.addEventListener("click", ()=>{ resetGame(); closeEvent(); });
      mChoices.appendChild(div);

      modalBack.style.display = "flex";
    }

    function resetGame(){
      state = freshState();
      elLog.innerHTML = "";
      logLine(`<span class="t">ç³»ç»Ÿ</span> èµ›å­£å·²é‡ç½®ã€‚`);
      updateHUD();
      // å¼€åœºäº‹ä»¶
      openEvent("start");
    }

    // ====== Init ======
    rollBtn.addEventListener("click", rollDice);
    resetBtn.addEventListener("click", resetGame);
    modalBack.addEventListener("click", (e)=>{
      if(e.target === modalBack) closeEvent();
    });

    state = freshState();
    updateHUD();
    logLine(`<span class="t">ç³»ç»Ÿ</span> æ‰“å¼€æˆåŠŸã€‚ç‚¹å‡»ã€Œæ·éª°å­ã€å¼€å§‹èµ°æ ¼å­ã€‚`);
    openEvent("start");
  </script>
</body>
</html>
